<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RupeeQ AI Agent Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            font-weight: bold;
        }
        .stats-card {
            text-align: center;
            padding: 15px;
        }
        .stats-card h2 {
            font-size: 2.5rem;
            margin-bottom: 5px;
            color: #0d6efd;
        }
        .stats-card p {
            color: #6c757d;
            margin-bottom: 0;
        }
        .live-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            background-color: #28a745;
            border-radius: 50%;
            margin-right: 5px;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .call-item {
            transition: all 0.2s;
        }
        .call-item:hover {
            background-color: #f8f9fa;
        }
        .agent-message {
            background-color: #e9f5ff;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        .customer-message {
            background-color: #f0f0f0;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        .transcript-container {
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <div class="container-fluid py-4">
        <header class="mb-4">
            <h1 class="mb-3">RupeeQ AI Agent Dashboard</h1>
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <span class="live-indicator"></span>
                    <span>Live Dashboard</span>
                    <small class="text-muted ms-2">Auto-refreshes every 30 seconds</small>
                </div>
                <div>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#filterModal">
                        <i class="bi bi-funnel"></i> Filter
                    </button>
                    <button class="btn btn-success" id="exportBtn">
                        <i class="bi bi-download"></i> Export
                    </button>
                </div>
            </div>
        </header>
        
        <div class="row">
            <!-- Statistics Cards -->
            <div class="col-md-3">
                <div class="card stats-card">
                    <h2 id="totalCalls">0</h2>
                    <p>Total Calls Today</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <h2 id="activeCalls">0</h2>
                    <p>Active Calls</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <h2 id="connectionRate">0%</h2>
                    <p>Connection Rate</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <h2 id="avgDuration">0:00</h2>
                    <p>Avg. Call Duration</p>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <!-- Charts -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">Call Status Distribution</div>
                    <div class="card-body">
                        <canvas id="statusChart" height="200"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">Call Outcome Distribution</div>
                    <div class="card-body">
                        <canvas id="outcomeChart" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <!-- Recent Calls -->
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>Recent Calls</div>
                        <div>
                            <span class="badge bg-secondary" id="filteredCallsCount">0</span> calls
                        </div>
                    </div>
                    <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                        <div id="recentCallsList">
                            <!-- Recent calls will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Call Details Modal -->
    <div class="modal fade" id="callDetailsModal" tabindex="-1" aria-labelledby="callDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="callDetailsModalLabel">Call Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Call Information</h6>
                            <table class="table table-sm">
                                <tr>
                                    <th>Customer</th>
                                    <td id="modalCustomerName"></td>
                                </tr>
                                <tr>
                                    <th>Status</th>
                                    <td><span id="modalStatus" class="badge"></span></td>
                                </tr>
                                <tr>
                                    <th>Duration</th>
                                    <td id="modalDuration"></td>
                                </tr>
                                <tr>
                                    <th>Start Time</th>
                                    <td id="modalStartTime"></td>
                                </tr>
                                <tr>
                                    <th>End Time</th>
                                    <td id="modalEndTime"></td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6>Call Outcome</h6>
                            <table class="table table-sm">
                                <tr>
                                    <th>Outcome</th>
                                    <td id="modalOutcome"></td>
                                </tr>
                                <tr>
                                    <th>Sentiment Score</th>
                                    <td id="modalSentiment"></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6>Call Transcript</h6>
                            <div id="modalTranscript" class="transcript-container">
                                <!-- Transcript messages will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Filter Modal -->
    <div class="modal fade" id="filterModal" tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="filterModalLabel">Filter Calls</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="filterStartDate" class="form-label">Start Date</label>
                        <input type="date" class="form-control" id="filterStartDate">
                    </div>
                    <div class="mb-3">
                        <label for="filterEndDate" class="form-label">End Date</label>
                        <input type="date" class="form-control" id="filterEndDate">
                    </div>
                    <div class="mb-3">
                        <label for="filterStatus" class="form-label">Status</label>
                        <select class="form-select" id="filterStatus">
                            <option value="">All</option>
                            <option value="completed">Completed</option>
                            <option value="in_progress">In Progress</option>
                            <option value="not_connected">Not Connected</option>
                            <option value="busy">Busy</option>
                            <option value="failed">Failed</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="filterOutcome" class="form-label">Outcome</label>
                        <select class="form-select" id="filterOutcome">
                            <option value="">All</option>
                            <option value="interested">Interested</option>
                            <option value="not_interested">Not Interested</option>
                            <option value="call_back">Call Back</option>
                            <option value="unknown">Unknown</option>
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="filterMinDuration" class="form-label">Min Duration (sec)</label>
                                <input type="number" class="form-control" id="filterMinDuration" min="0">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="filterMaxDuration" class="form-label">Max Duration (sec)</label>
                                <input type="number" class="form-control" id="filterMaxDuration" min="0">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="filterKeyword" class="form-label">Keyword in Transcript</label>
                        <input type="text" class="form-control" id="filterKeyword" placeholder="Search in transcripts...">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="applyFiltersBtn" data-bs-dismiss="modal">Apply Filters</button>
                </div>
            </div>
        </div>
    </div>
<script>
    // Dashboard JavaScript
    let statusChart, outcomeChart;
    let currentFilters = {};
    
    // Initialize charts
    function initCharts() {
        const statusCtx = document.getElementById('statusChart').getContext('2d');
        statusChart = new Chart(statusCtx, {
            type: 'pie',
            data: {
                labels: ['Completed', 'In Progress', 'Not Connected', 'Busy', 'Failed'],
                datasets: [{
                    data: [0, 0, 0, 0, 0],
                    backgroundColor: ['#28a745', '#17a2b8', '#ffc107', '#fd7e14', '#dc3545']
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'right'
                    }
                }
            }
        });
        
        const outcomeCtx = document.getElementById('outcomeChart').getContext('2d');
        outcomeChart = new Chart(outcomeCtx, {
            type: 'pie',
            data: {
                labels: ['Interested', 'Not Interested', 'Call Back', 'Unknown'],
                datasets: [{
                    data: [0, 0, 0, 0],
                    backgroundColor: ['#28a745', '#dc3545', '#ffc107', '#6c757d']
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'right'
                    }
                }
            }
        });
    }
    
    // Load dashboard data
    function loadDashboardData() {
        fetch('/api/calls')
            .then(response => response.json())
            .then(data => {
                updateDashboardStats(data.stats);
                updatePerformanceMetrics(data.performance);
                updateRecentCalls(data.recent_calls);
                updateCharts(data.stats);
            })
            .catch(error => console.error('Error loading dashboard data:', error));
    }
    
    // Update dashboard statistics
    function updateDashboardStats(stats) {
        document.getElementById('totalCalls').textContent = stats.total_calls;
        document.getElementById('activeCalls').textContent = stats.active_calls;
        document.getElementById('connectionRate').textContent = stats.connection_rate + '%';
    }
    
    // Update performance metrics
    function updatePerformanceMetrics(performance) {
        document.getElementById('avgDuration').textContent = formatDuration(performance.avg_duration);
    }
    
    // Update charts with new data
    function updateCharts(stats) {
        // Update status chart
        statusChart.data.datasets[0].data = [
            stats.status_counts.completed || 0,
            stats.status_counts.in_progress || 0,
            stats.status_counts.not_connected || 0,
            stats.status_counts.busy || 0,
            stats.status_counts.failed || 0
        ];
        statusChart.update();
        
        // Update outcome chart
        outcomeChart.data.datasets[0].data = [
            stats.outcome_counts.interested || 0,
            stats.outcome_counts.not_interested || 0,
            stats.outcome_counts.call_back || 0,
            stats.outcome_counts.unknown || 0
        ];
        outcomeChart.update();
    }
    
    // Update recent calls list
    function updateRecentCalls(calls) {
        const recentCallsList = document.getElementById('recentCallsList');
        document.getElementById('filteredCallsCount').textContent = calls.length;
        
        if (calls.length === 0) {
            recentCallsList.innerHTML = '<div class="text-center py-4">No calls found</div>';
            return;
        }
        
        recentCallsList.innerHTML = '';
        calls.forEach(call => {
            const callItem = document.createElement('div');
            callItem.className = 'call-item';
            callItem.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6>${maskCustomerName(call.customer_name)}</h6>
                        <div class="text-muted small">${call.start_time}</div>
                    </div>
                    <div class="d-flex align-items-center">
                        <span class="badge ${getStatusBadgeClass(call.status)} me-2">${call.status}</span>
                        <span class="me-3">${formatDuration(call.duration)}</span>
                        <button class="btn btn-sm btn-outline-primary view-details-btn" data-call-id="${call.id}">Details</button>
                    </div>
                </div>
            `;
            recentCallsList.appendChild(callItem);
            
            // Add event listener to the details button
            const detailsBtn = callItem.querySelector('.view-details-btn');
            detailsBtn.addEventListener('click', () => {
                showCallDetails(call.id);
            });
        });
    }
    
    // Show call details in modal
    function showCallDetails(callId) {
        fetch(`/api/calls/${callId}`)
            .then(response => response.json())
            .then(data => {
                // Populate modal with call details
                document.getElementById('modalCustomerName').textContent = maskCustomerName(data.call.customer_name);
                
                const statusBadge = document.getElementById('modalStatus');
                statusBadge.textContent = data.call.status;
                statusBadge.className = `badge ${getStatusBadgeClass(data.call.status)}`;
                
                document.getElementById('modalDuration').textContent = formatDuration(data.call.duration);
                document.getElementById('modalStartTime').textContent = data.call.start_time;
                document.getElementById('modalEndTime').textContent = data.call.end_time || 'In Progress';
                document.getElementById('modalOutcome').textContent = data.call.outcome || 'Unknown';
                document.getElementById('modalSentiment').textContent = data.call.sentiment_score || 'N/A';
                
                // Populate transcript
                const transcriptContainer = document.getElementById('modalTranscript');
                transcriptContainer.innerHTML = '';
                
                if (data.transcripts && data.transcripts.length > 0) {
                    data.transcripts.forEach(transcript => {
                        const messageDiv = document.createElement('div');
                        messageDiv.className = `transcript-message ${transcript.speaker === 'agent' ? 'agent' : 'customer'}`;
                        messageDiv.innerHTML = `
                            <div class="message-header">
                                <span class="speaker">${transcript.speaker === 'agent' ? 'AI Agent' : 'Customer'}</span>
                                <span class="timestamp">${transcript.timestamp}</span>
                            </div>
                            <div class="message-content">${transcript.text}</div>
                        `;
                        transcriptContainer.appendChild(messageDiv);
                    });
                } else {
                    transcriptContainer.innerHTML = '<div class="text-center py-3">No transcript available</div>';
                }
                
                // Show the modal
                const modal = new bootstrap.Modal(document.getElementById('callDetailsModal'));
                modal.show();
            })
            .catch(error => console.error('Error loading call details:', error));
    }
    
    // Apply filters
    function applyFilters() {
        const filters = {
            start_date: document.getElementById('filterStartDate').value || null,
            end_date: document.getElementById('filterEndDate').value || null,
            status: document.getElementById('filterStatus').value || null,
            outcome: document.getElementById('filterOutcome').value || null,
            min_duration: document.getElementById('filterMinDuration').value || null,
            max_duration: document.getElementById('filterMaxDuration').value || null,
            keyword: document.getElementById('filterKeyword').value || null
        };
        
        // Remove null values
        Object.keys(filters).forEach(key => {
            if (filters[key] === null) {
                delete filters[key];
            }
        });
        
        currentFilters = filters;
        
        // Fetch filtered calls
        fetch('/api/calls/filtered', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ filters: filters })
        })
        .then(response => response.json())
        .then(data => {
            updateRecentCalls(data.calls);
        })
        .catch(error => console.error('Error applying filters:', error));
    }
    
    // Export filtered calls
    function exportCalls() {
        fetch('/api/calls/export', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ filters: currentFilters, format: 'csv' })
        })
        .then(response => response.blob())
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = 'calls_export.csv';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
        })
        .catch(error => console.error('Error exporting calls:', error));
    }
    
    // Helper function to format duration
    function formatDuration(seconds) {
        if (!seconds) return '0:00';
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }
    
    // Helper function to mask customer name
    function maskCustomerName(name) {
        if (!name) return 'Unknown';
        const parts = name.split(' ');
        if (parts.length === 1) {
            return parts[0].charAt(0) + '*'.repeat(parts[0].length - 1);
        } else {
            return parts[0].charAt(0) + '*'.repeat(parts[0].length - 1) + ' ' + 
                   parts[parts.length - 1].charAt(0) + '*'.repeat(parts[parts.length - 1].length - 1);
        }
    }
    
    // Helper function to get status badge class
    function getStatusBadgeClass(status) {
        switch (status) {
            case 'completed': return 'bg-success';
            case 'in_progress': return 'bg-info';
            case 'not_connected': return 'bg-warning';
            case 'busy': return 'bg-warning';
            case 'failed': return 'bg-danger';
            default: return 'bg-secondary';
        }
    }
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize charts
        const statusChartCtx = document.getElementById('statusChart').getContext('2d');
        const outcomeChartCtx = document.getElementById('outcomeChart').getContext('2d');
        
        window.statusChart = new Chart(statusChartCtx, {
            type: 'doughnut',
            data: {
                labels: ['Connected', 'Not Connected', 'Busy', 'Failed'],
                datasets: [{
                    data: [0, 0, 0, 0],
                    backgroundColor: ['#28a745', '#17a2b8', '#ffc107', '#dc3545']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
        
        window.outcomeChart = new Chart(outcomeChartCtx, {
            type: 'doughnut',
            data: {
                labels: ['Interested', 'Not Interested', 'Call Back', 'Unknown'],
                datasets: [{
                    data: [0, 0, 0, 0],
                    backgroundColor: ['#28a745', '#dc3545', '#ffc107', '#6c757d']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
        
        // Load initial dashboard data
        loadDashboardData();
        
        // Set up auto-refresh (every 30 seconds)
        setInterval(loadDashboardData, 30000);
    });
    
    // Function to load dashboard data
    function loadDashboardData() {
        fetch('/api/calls')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateStatistics(data.statistics);
                    updatePerformanceMetrics(data.performance_metrics);
                    updateRecentCalls(data.recent_calls);
                    updateCharts(data.statistics, data.outcome_distribution);
                }
            })
            .catch(error => {
                console.error('Error loading dashboard data:', error);
            });
    }
        
        // Function to update statistics
        function updateStatistics(statistics) {
            document.getElementById('totalCalls').textContent = statistics.total_calls_today;
            document.getElementById('activeCalls').textContent = statistics.active_calls;
            document.getElementById('connectionRate').textContent = statistics.connection_rate + '%';
            document.getElementById('avgDuration').textContent = formatDuration(statistics.avg_call_duration);
        }
        
        // Function to update performance metrics
        function updatePerformanceMetrics(metrics) {
            document.getElementById('interestedRate').textContent = metrics.interested_rate + '%';
            document.getElementById('callbackRate').textContent = metrics.callback_rate + '%';
            document.getElementById('avgSentiment').textContent = metrics.avg_sentiment.toFixed(1);
        }
        
        // Function to update recent calls
        function updateRecentCalls(calls) {
            const recentCallsList = document.getElementById('recentCallsList');
            recentCallsList.innerHTML = '';
            
            if (calls.length === 0) {
                recentCallsList.innerHTML = '<div class="text-center p-3">No recent calls</div>';
                return;
            }
            
            calls.forEach(call => {
                const callItem = document.createElement('div');
                callItem.className = 'call-item p-3 border-bottom';
                callItem.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-0">${maskCustomerName(call.customer_name)}</h6>
                            <small class="text-muted">${call.start_time}</small>
                        </div>
                        <div>
                            <span class="badge ${getStatusBadgeClass(call.status)}">${call.status}</span>
                            <span class="ms-2">${call.duration_formatted || '0:00'}</span>
                        </div>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted">Outcome: ${call.outcome}</small>
                        <button class="btn btn-sm btn-outline-primary float-end" 
                                onclick="showCallDetails('${call.call_id}')">
                            Details
                        </button>
                    </div>
                `;
                recentCallsList.appendChild(callItem);
            });
        }
        
        // Function to update charts
        function updateCharts(stats, outcomes) {
            // Update status chart
            if (window.statusChart) {
                window.statusChart.data.datasets[0].data = [
                    stats.connected_calls || 0,
                    stats.not_connected || 0,
                    stats.busy || 0,
                    stats.failed || 0
                ];
                window.statusChart.update();
            }
            
            // Update outcome chart
            if (window.outcomeChart) {
                window.outcomeChart.data.datasets[0].data = [
                    outcomes.interested || 0,
                    outcomes.not_interested || 0,
                    outcomes.call_back || 0,
                    outcomes.unknown || 0
                ];
                window.outcomeChart.update();
            }
        }
        
        // Function to show call details
        function showCallDetails(callId) {
            fetch(`/api/calls/${callId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const call = data.call;
                        const transcripts = data.transcripts;
                        
                        // Populate modal with call details
                        document.getElementById('callDetailTitle').textContent = `Call Details: ${maskCustomerName(call.customer_name)}`;
                        document.getElementById('callDetailStatus').textContent = call.status;
                        document.getElementById('callDetailStatus').className = `badge ${getStatusBadgeClass(call.status)}`;
                        document.getElementById('callDetailDuration').textContent = call.duration_formatted || '0:00';
                        document.getElementById('callDetailStartTime').textContent = call.start_time;
                        document.getElementById('callDetailEndTime').textContent = call.end_time || 'In Progress';
                        document.getElementById('callDetailOutcome').textContent = call.outcome;
                        document.getElementById('callDetailSentiment').textContent = call.sentiment_score;
                        
                        // Populate transcripts
                        const transcriptsList = document.getElementById('callTranscripts');
                        transcriptsList.innerHTML = '';
                        
                        if (transcripts.length === 0) {
                            transcriptsList.innerHTML = '<div class="text-center p-3">No transcripts available</div>';
                        } else {
                            transcripts.forEach(transcript => {
                                const transcriptItem = document.createElement('div');
                                transcriptItem.className = `transcript-item p-2 ${transcript.speaker === 'agent' ? 'agent-message' : 'customer-message'}`;
                                transcriptItem.innerHTML = `
                                    <div class="d-flex justify-content-between">
                                        <strong>${transcript.speaker === 'agent' ? 'AI Agent' : 'Customer'}</strong>
                                        <small class="text-muted">${transcript.timestamp_formatted}</small>
                                    </div>
                                    <div class="mt-1">${transcript.message}</div>
                                `;
                                transcriptsList.appendChild(transcriptItem);
                            });
                        }
                        
                        // Show modal
                        const callDetailModal = new bootstrap.Modal(document.getElementById('callDetailModal'));
                        callDetailModal.show();
                    }
                })
                .catch(error => console.error('Error loading call details:', error));
        }
        
        // Function to apply filters
        function applyFilters() {
            // Show loading indicator
            document.getElementById('applyFiltersBtn').innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Applying...';
            document.getElementById('applyFiltersBtn').disabled = true;
            
            const filters = {
                start_date: document.getElementById('filterStartDate').value,
                end_date: document.getElementById('filterEndDate').value,
                status: document.getElementById('filterStatus').value,
                outcome: document.getElementById('filterOutcome').value,
                min_duration: document.getElementById('filterMinDuration').value,
                max_duration: document.getElementById('filterMaxDuration').value,
                keyword: document.getElementById('filterKeyword').value,
                limit: 50
            };
            
            fetch('/api/calls/filtered', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(filters)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateRecentCalls(data.calls);
                    document.getElementById('filteredCallsCount').textContent = data.count;
                    // Show success message
                    showAlert('Filters applied successfully!', 'success');
                }
            })
            .catch(error => console.error('Error applying filters:', error))
            .finally(() => {
                // Reset button
                document.getElementById('applyFiltersBtn').innerHTML = 'Apply Filters';
                document.getElementById('applyFiltersBtn').disabled = false;
            });
        }
        
        // Function to export filtered calls
        function exportCalls() {
            const filters = {
                start_date: document.getElementById('filterStartDate').value,
                end_date: document.getElementById('filterEndDate').value,
                status: document.getElementById('filterStatus').value,
                outcome: document.getElementById('filterOutcome').value,
                min_duration: document.getElementById('filterMinDuration').value,
                max_duration: document.getElementById('filterMaxDuration').value,
                keyword: document.getElementById('filterKeyword').value
            };
            
            // Show loading indicator
            document.getElementById('exportBtn').innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Exporting...';
            document.getElementById('exportBtn').disabled = true;
            
            fetch('/api/calls/export', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(filters)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Convert to CSV
                    const csvContent = convertToCSV(data.data);
                    
                    // Create download link
                    const encodedUri = encodeURI('data:text/csv;charset=utf-8,' + csvContent);
                    const link = document.createElement('a');
                    link.setAttribute('href', encodedUri);
                    link.setAttribute('download', data.filename);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    // Show success message
                    showAlert('Export successful! File downloaded.', 'success');
                } else {
                    showAlert('Export failed: ' + data.error, 'danger');
                }
            })
            .catch(error => {
                console.error('Error exporting calls:', error);
                showAlert('Export failed: ' + error, 'danger');
            })
            .finally(() => {
                // Reset button
                document.getElementById('exportBtn').innerHTML = 'Export';
                document.getElementById('exportBtn').disabled = false;
            });
        }
        
        // Helper function to convert JSON to CSV
        function convertToCSV(objArray) {
            const array = typeof objArray !== 'object' ? JSON.parse(objArray) : objArray;
            let str = '';
            
            // Add header row
            const headers = Object.keys(array[0]);
            str += headers.join(',') + '\r\n';
            
            // Add data rows
            for (let i = 0; i < array.length; i++) {
                let line = '';
                for (let index in headers) {
                    if (line !== '') line += ',';
                    let value = array[i][headers[index]];
                    if (value === null || value === undefined) value = '';
                    value = value.toString().replace(/"/g, '""');
                    if (value.includes(',') || value.includes('"') || value.includes('\n')) {
                        value = '"' + value + '"';
                    }
                    line += value;
                }
                str += line + '\r\n';
            }
            return str;
        }
        
        // Helper function to mask customer name
        function maskCustomerName(name) {
            if (!name) return 'Unknown';
            const parts = name.split(' ');
            if (parts.length === 1) {
                return parts[0].charAt(0) + '*'.repeat(parts[0].length - 1);
            } else {
                return parts[0] + ' ' + parts[1].charAt(0) + '*'.repeat(parts[1].length - 1);
            }
        }
        
        // Helper function to get status badge class
        function getStatusBadgeClass(status) {
            switch (status) {
                case 'completed':
                case 'connected':
                    return 'bg-success';
                case 'in_progress':
                    return 'bg-primary';
                case 'not_connected':
                    return 'bg-danger';
                case 'busy':
                    return 'bg-warning';
                case 'failed':
                    return 'bg-secondary';
                default:
                    return 'bg-info';
            }
        }
        
        // Helper function to show alerts
        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alertContainer');
            if (!alertContainer) {
                const container = document.createElement('div');
                container.id = 'alertContainer';
                container.style.position = 'fixed';
                container.style.top = '20px';
                container.style.right = '20px';
                container.style.zIndex = '9999';
                document.body.appendChild(container);
            }
            
            const alertId = 'alert-' + Date.now();
            const alertHtml = `
                <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            
            document.getElementById('alertContainer') || document.body.appendChild(container);
            document.getElementById('alertContainer').innerHTML += alertHtml;
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                const alertElement = document.getElementById(alertId);
                if (alertElement) {
                    alertElement.classList.remove('show');
                    setTimeout(() => alertElement.remove(), 300);
                }
            }, 5000);
        }
        
        // Initialize dashboard
        loadDashboardData();
        
        // Set up filter event listeners
        document.getElementById('applyFiltersBtn').addEventListener('click', applyFilters);
        document.getElementById('exportBtn').addEventListener('click', exportCalls);
        
        // Auto-refresh dashboard every 30 seconds
        setInterval(loadDashboardData, 30000);
    });
</script>